<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <!-- å¼•å…¥å¿…è¦çš„åº“: jQueryç”¨äºç®€åŒ–DOMæ“ä½œ, Cytoscapeæ ¸å¿ƒåº“, Dagreç”¨äºæ ‘çŠ¶å¸ƒå±€, ä»¥åŠCytoscapeçš„ç›¸å…³æ’ä»¶ -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.min.js"></script>

    <style>
        /* CSSæ ·å¼éƒ¨åˆ† */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; display: flex; flex-direction: column;
        }
        #cy {
            flex-grow: 1; position: relative;
            background-color: #f8f9fa;
            transition: background-color 0.4s ease;
        }
        body.highlight-active #cy { background-color: #e9ecef; }

        .controls {
            display: flex; align-items: center; gap: 16px;
            padding: 10px 20px; background-color: #ffffff;
            border-bottom: 1px solid #e9ecef; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; font-weight: 500; color: #495057; }
        select, input[type="text"], button {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;
            font-size: 13px; background-color: #fff;
            transition: all 0.2s ease-in-out;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }
        button:hover { background-color: #0069d9; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }
        #help-button { background-color: #ffc107; color: #212529; border-color: #e0a800; }
        #help-button:hover { background-color: #e0a800; }

        /* --- æ–°å¢å’Œä¿®æ”¹çš„æœç´¢æ¡†æ ·å¼ --- */
        .search-input-wrapper {position: relative;display: flex;flex-grow: 1;max-width: 500px;}
        #search-scope-select { border-right: none; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        #search-input { flex-grow: 1; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        #autocomplete-suggestions {
            display: none; position: absolute; top: 100%;
            left: 0; right: 0; margin-top: 2px;
            background: white; border: 1px solid #ced4da;
            border-radius: 6px; max-height: 300px;
            overflow-y: auto; z-index: 1001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 10px 15px; cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
            display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f8f9fa; }
        .suggestion-item .item-text { font-weight: 500; color: #212529; }
        .suggestion-item .item-type {
            font-size: 11px; color: #6c757d;
            background-color: #e9ecef; padding: 2px 6px;
            border-radius: 4px; text-transform: capitalize;
        }
        /* --- ç»“æŸï¼šæ–°å¢å’Œä¿®æ”¹çš„æœç´¢æ¡†æ ·å¼ --- */

        .node-card {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;
            padding: 10px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 300px; user-select: text; pointer-events: none;
            text-align: left; position: relative;
            transition: opacity 0.4s ease, filter 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .node-class-name { font-size: 18px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
        .node-method-name { font-size: 14px; font-weight: 600; color: #00529b; margin-bottom: 4px; }
        .node-params, .node-package-name { font-size: 7px; color: #6c757d; line-height: 0.9; }
        .node-package-name { margin-top: 3px; border-top: 1px dashed #eee; padding-top: 3px; }
        .node-card.dimmed { opacity: 0.15; filter: grayscale(80%); }
        .node-card.highlighted { opacity: 1 !important; filter: none !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4); }

        .node-card.copied { border-color: #28a745; }
        .copy-feedback { display: none; position: absolute; top: 5px; right: 8px; background-color: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .node-card.copied .copy-feedback { display: block; }

        .context-menu {
            display: none; position: absolute; z-index: 1000;
            background-color: #ffffff; border: 1px solid #ccc;
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px 0; min-width: 220px;
        }
        .context-menu ul { list-style: none; padding: 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; font-size: 13px; cursor: pointer; display: flex; align-items: center; }
        .context-menu ul li:hover { background-color: #007bff; color: white; }
        .context-menu ul li .icon { margin-right: 10px; font-size: 16px; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: #fff; padding: 25px 35px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; max-width: 650px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 28px; font-weight: bold; color: #aaa;
            cursor: pointer; transition: color 0.2s;
        }
        .modal-close-btn:hover { color: #333; }
        .modal-content h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-content ul { padding-left: 20px; line-height: 1.8; }
        .modal-content kbd {
            background-color: #f7f7f7; border: 1px solid #ccc; border-radius: 4px;
            padding: 2px 6px; margin: 0 2px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em; color: #333;
        }
        .color-swatch {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="controls">
    <button id="help-button">ğŸ’¡ ä½¿ç”¨é¡»çŸ¥</button>
    <div class="control-group">
        <label for="layout-select">å¸ƒå±€:</label>
        <select id="layout-select"><option value="dagre" selected>Dagre (Tree)</option><option value="breadthfirst">Breadthfirst</option><option value="circle">Circle</option><option value="grid">Grid</option></select>
    </div>
    <!-- *** MODIFIED: Search UI block *** -->
    <div class="control-group"> <!-- ç§»é™¤ search-container ç±» -->
        <label for="search-input">æŸ¥è¯¢:</label>
        <div class="search-input-wrapper"> <!-- æ–°å¢: è¾“å…¥å­—æ®µçš„ä¸“å±åŒ…è£…å™¨ -->
            <select id="search-scope-select">
                <option value="all" selected>å…¨éƒ¨</option>
                <option value="class">ç±»</option>
                <option value="method">æ–¹æ³•</option>
            </select>
            <input type="text" id="search-input" placeholder="è¾“å…¥ä»¥è¿›è¡Œæ¨¡ç³Šæœç´¢..." autocomplete="off">
            <div id="autocomplete-suggestions"></div>
        </div>
    </div>
    <!-- *** END MODIFIED *** -->
    <button id="reset-button">é‡ç½®</button>
</div>

<div id="cy"></div>

<div id="context-menu" class="context-menu">
    <ul>
        <li id="copy-node-info-btn"><span class="icon">ğŸ“‹</span>å¤åˆ¶</li>
        <li id="delete-node-btn"><span class="icon">ğŸ—‘ï¸</span>åˆ é™¤èŠ‚ç‚¹&ä¿®å‰ªé“¾è·¯</li>
    </ul>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn">Ã—</span>
        <h2>ä½¿ç”¨é¡»çŸ¥</h2>
        <ul>
            <li><strong>æŸ¥çœ‹ä¸å¯¼èˆª:</strong>
                <ul>
                    <li>ä½¿ç”¨é¼ æ ‡æ»šè½®è¿›è¡Œç¼©æ”¾ã€‚</li>
                    <li>æŒ‰ä½å¹¶æ‹–åŠ¨ç”»å¸ƒç©ºç™½å¤„è¿›è¡Œå¹³ç§»ã€‚</li>
                </ul>
            </li>
            <li><strong>èŠ‚ç‚¹é¢œè‰²è¯´æ˜:</strong>
                <ul>
                    <li><span class="color-swatch" style="background-color: #eceff1; border-left: 5px solid #b0bec5;"></span><strong>ç°è‰² (Root):</strong> è°ƒç”¨é“¾çš„<b>é¡¶ç«¯</b>ã€‚åœ¨å½“å‰å›¾ä¸­ï¼Œå®ƒåªè¢«è°ƒç”¨ï¼Œä¸è°ƒç”¨ä»»ä½•å…¶ä»–èŠ‚ç‚¹ã€‚</li>
                    <li><span class="color-swatch" style="background-color: #e3f2fd; border-left: 5px solid #42a5f5;"></span><strong>è“è‰² (Intermediate):</strong> è°ƒç”¨é“¾çš„<b>ä¸­é—´èŠ‚ç‚¹</b>ã€‚å®ƒæ—¢è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œä¹Ÿè¢«å…¶ä»–æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯å…³ç³»å›¾çš„æ¢çº½ã€‚</li>
                    <li><span class="color-swatch" style="background-color: #e8f5e9; border-left: 5px solid #66bb6a;"></span><strong>ç»¿è‰² (Leaf):</strong> è°ƒç”¨é“¾çš„<b>æœ«ç«¯</b>ã€‚åœ¨å½“å‰å›¾ä¸­ï¼Œå®ƒåªå‘èµ·è°ƒç”¨ï¼Œè€Œä¸è¢«ä»»ä½•èŠ‚ç‚¹è°ƒç”¨ï¼Œæ˜¯åˆ†æçš„èµ·ç‚¹ã€‚</li>
                </ul>
            </li>
            <li><strong>é«˜äº®è°ƒç”¨é“¾:</strong>
                <ul>
                    <li><strong>å·¦é”®å•å‡»</strong>ä»»æ„èŠ‚ç‚¹ï¼Œå³å¯é«˜äº®å…¶å®Œæ•´çš„ä¸Šæ¸¸å’Œä¸‹æ¸¸è°ƒç”¨é“¾ã€‚</li>
                </ul>
            </li>
            <li><strong>å¤åˆ¶èŠ‚ç‚¹ä¿¡æ¯:</strong>
                <ul>
                    <li><strong>å·¦é”®å•å‡»</strong>é€‰ä¸­èŠ‚ç‚¹åï¼ŒæŒ‰ <kbd>Cmd</kbd> + <kbd>C</kbd> (æˆ– <kbd>Ctrl</kbd> + <kbd>C</kbd>)ã€‚</li>
                    <li>æˆ–<strong>å³é”®å•å‡»</strong>èŠ‚ç‚¹ï¼Œåœ¨èœå•ä¸­é€‰æ‹©â€œå¤åˆ¶â€ã€‚</li>
                </ul>
            </li>
            <li><strong>åˆ é™¤èŠ‚ç‚¹ä¸ä¿®å‰ª:</strong>
                <ul>
                    <li><strong>å·¦é”®å•å‡»</strong>é€‰ä¸­èŠ‚ç‚¹åï¼ŒæŒ‰ <kbd>Delete</kbd> é”® (æˆ– <kbd>Cmd</kbd> + <kbd>Backspace</kbd>)ã€‚</li>
                    <li>æˆ–<strong>å³é”®å•å‡»</strong>èŠ‚ç‚¹ï¼Œåœ¨èœå•ä¸­é€‰æ‹©â€œåˆ é™¤èŠ‚ç‚¹&ä¿®å‰ªé“¾è·¯â€ã€‚</li>
                    <li>è¯¥æ“ä½œä¼šè‡ªåŠ¨ç§»é™¤æ‰€æœ‰ä»…ä¸è¢«åˆ é™¤é“¾è·¯ç›¸å…³çš„â€œå­¤ç«‹â€èŠ‚ç‚¹ã€‚</li>
                </ul>
            </li>
            <li><strong>é‡ç½®è§†å›¾:</strong>
                <ul>
                    <li>ç‚¹å‡»ç”»å¸ƒä»»æ„ç©ºç™½å¤„ï¼Œå¯æ¸…é™¤æ‰€æœ‰é«˜äº®çŠ¶æ€ã€‚</li>
                    <li>ç‚¹å‡»é¡¶éƒ¨çš„â€œé‡ç½®â€æŒ‰é’®ï¼Œå¯æ¸…é™¤é«˜äº®ã€æ¸…ç©ºæœç´¢å¹¶ä½¿è§†å›¾å±…ä¸­ã€‚</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<script>
    // ç¡®ä¿ Cytoscape æ’ä»¶å·²æ­£ç¡®åŠ è½½
    if(typeof cytoscapeNodeHtmlLabel === 'function') cytoscape.use(cytoscapeNodeHtmlLabel);
    if(typeof cytoscapeDagre === 'function') cytoscape.use(cytoscapeDagre);

    // å¾…æ–‡æ¡£åŠ è½½å®Œæ¯•åï¼Œæ‰§è¡Œå›¾è¡¨åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', function () {

        // =========================================================================
        // === 1. å›¾è¡¨åˆå§‹åŒ– (Initialization)
        // =========================================================================

        // ä»å ä½ç¬¦è·å–ç”±åç«¯æ³¨å…¥çš„JSONæ•°æ®
        const graphData = '{graph_data_placeholder}';
        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "é”™è¯¯ï¼šæ— æ³•åŠ è½½å›¾è¡¨æ•°æ®ã€‚";
            return;
        }

        // *** NEW: Create a searchable data source from graph data ***
        const searchableData = graphData.nodes.map(node => ({
            id: node.id,
            className: node.className.toLowerCase(),
            methodName: node.methodName.toLowerCase(),
            fullClassName: node.className,
            fullMethodName: node.methodName,
        }));

        // åˆ›å»º Cytoscape å®ä¾‹ï¼Œè¿™æ˜¯æ‰€æœ‰å¯è§†åŒ–æ“ä½œçš„æ ¸å¿ƒ
        const cy = cytoscape({
            container: document.getElementById('cy'), // ç»‘å®šåˆ°ç”»å¸ƒDOMå…ƒç´ 

            // å®šä¹‰å›¾çš„å…ƒç´ ï¼ˆèŠ‚ç‚¹å’Œè¾¹ï¼‰
            elements: {
                nodes: graphData.nodes.map(node => ({ data: { id: node.id, ...node } })),
                edges: graphData.edges.map(edge => ({ data: { id: `edge_${edge.source}_${edge.target}`, source: edge.source, target: edge.target } }))
            },

            // å®šä¹‰å…¨å±€æ ·å¼
            style: [
                // èŠ‚ç‚¹é»˜è®¤é€æ˜ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨HTMLæ¨¡æ¿æ¥æ¸²æŸ“å…¶å¤–è§‚
                { selector: 'node', style: { 'background-opacity': 0, 'border-width': 0, 'width': 320, 'height': 110, 'shape': 'rectangle' }},
                // è¾¹çš„é»˜è®¤æ ·å¼
                { selector: 'edge', style: { 'width': 2, 'line-color': '#adb5bd', 'target-arrow-color': '#adb5bd', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'transition-property': 'line-color, target-arrow-color, width, opacity', 'transition-duration': '0.3s' }},
                // é«˜äº®çŠ¶æ€çš„è¾¹
                { selector: 'edge.highlighted', style: { 'line-color': '#007bff', 'target-arrow-color': '#007bff', 'width': 3.5, 'opacity': 1, 'z-index': 100 }},
                // è™šåŒ–çŠ¶æ€çš„è¾¹
                { selector: 'edge.dimmed', style: { 'opacity': 0.1 }}
            ],

            // æŒ‡å®šåˆå§‹å¸ƒå±€ç®—æ³•
            layout: { name: 'dagre', rankDir: 'LR', spacingFactor: 1.5 }
        });

        // ä½¿ç”¨ node-html-label æ’ä»¶ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®åŠ¨æ€æ¸²æŸ“æˆä¸€ä¸ªHTMLä¿¡æ¯å¡ç‰‡
        cy.nodeHtmlLabel([
            {
                query: 'node', valign: "center", halign: "center",
                tpl: (data) => {
                    // æ ¹æ®åç«¯ä¼ æ¥çš„ nodeType (ROOT, LEAF, INTERMEDIATE) è®¾ç½®ä¸åŒçš„èƒŒæ™¯å’Œè¾¹æ¡†é¢œè‰²ï¼Œä»¥åœ¨è§†è§‰ä¸ŠåŒºåˆ†èŠ‚ç‚¹ç±»å‹
                    let borderStyle = '', bgColor = '';
                    switch(data.nodeType) {
                        case 'ROOT': borderStyle = 'border-left: 5px solid #b0bec5;'; bgColor = '#eceff1'; break;
                        case 'LEAF': borderStyle = 'border-left: 5px solid #66bb6a;'; bgColor = '#e8f5e9'; break;
                        default: borderStyle = 'border-left: 5px solid #42a5f5;'; bgColor = '#e3f2fd'; break;
                    }
                    const finalStyle = `${borderStyle} background-color: ${bgColor};`;
                    // è¿”å›æœ€ç»ˆçš„HTMLå­—ç¬¦ä¸²æ¨¡æ¿
                    return `<div id="card-${data.id}" class="node-card" style="${finalStyle}"><div class="copy-feedback">Copied!</div><div class="node-class-name" style="color: ${data.classColor};" title="${data.className}">${data.className}</div><div class="node-method-name" title="${data.methodName}">${data.methodName}</div><div class="node-params" title="${data.params}">(${data.params})</div><div class="node-package-name" title="${data.packageName}">${data.packageName}</div></div>`;
                }
            }
        ]);


        // =========================================================================
        // === 2. æ ¸å¿ƒäº¤äº’å‡½æ•° (Core Interaction Functions)
        // =========================================================================

        /**
         * é«˜äº®æŒ‡å®šçš„å…ƒç´ é›†åˆï¼Œå¹¶è™šåŒ–å…¶ä»–æ‰€æœ‰å…ƒç´ ã€‚
         * @param {Collection} elementsToShow - éœ€è¦é«˜äº®çš„Cytoscapeå…ƒç´ é›†åˆã€‚
         */
        function highlightElements(elementsToShow) {
            document.body.classList.add('highlight-active');
            cy.edges().addClass('dimmed');
            $('.node-card').addClass('dimmed').removeClass('highlighted');
            elementsToShow.edges().removeClass('dimmed').addClass('highlighted');
            elementsToShow.nodes().forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
        }

        /**
         * æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œè™šåŒ–æ•ˆæœï¼Œæ¢å¤å›¾è¡¨çš„é»˜è®¤çŠ¶æ€ã€‚
         */
        function resetHighlight() {
            document.body.classList.remove('highlight-active');
            cy.elements().removeClass('dimmed highlighted');
            $('.node-card').removeClass('dimmed highlighted');
        }

        /**
         * å°†æŒ‡å®šèŠ‚ç‚¹çš„å…³é”®ä¿¡æ¯å¤åˆ¶åˆ°ç”¨æˆ·å‰ªè´´æ¿ï¼Œå¹¶æä¾›è§†è§‰åé¦ˆã€‚
         * @param {NodeSingular} node - è¦å¤åˆ¶ä¿¡æ¯çš„èŠ‚ç‚¹ã€‚
         */
        function copyNodeInfo(node) {
            if (!node) return;
            const data = node.data();
            const textToCopy = `${data.packageName}.${data.className}#${data.methodName}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const card = $(`#card-${node.id()}`);
                card.addClass('copied');
                setTimeout(() => card.removeClass('copied'), 1500); // 1.5ç§’åç§»é™¤å¤åˆ¶æˆåŠŸçŠ¶æ€
            }).catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
        }

        /**
         * [æ ¸å¿ƒç®—æ³•] è¿­ä»£å¼åˆ é™¤èŠ‚ç‚¹å¹¶ä¿®å‰ªæ‰€æœ‰å…³è”çš„å­¤ç«‹è°ƒç”¨é“¾ã€‚
         *
         * è®¾è®¡æ€è·¯:
         * è¿™æ˜¯ä¸€ä¸ªè¿­ä»£æ”¶æ•›ç®—æ³•ï¼Œæ—¨åœ¨è§£å†³å¤æ‚ä¾èµ–å…³ç³»ä¸‹çš„ä¿®å‰ªé—®é¢˜ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹æœ‰å¤šä¸ªå¾…åˆ é™¤çš„çˆ¶èŠ‚ç‚¹ï¼‰ã€‚
         * ç®—æ³•ä¼šåå¤æ‰«æå…¨å›¾ï¼Œç›´åˆ°åœ¨ä¸€è½®å®Œæ•´çš„æ‰«æä¸­å†ä¹Ÿæ‰¾ä¸åˆ°ä»»ä½•å¯ä»¥è¢«ä¿®å‰ªçš„â€œå­¤ç«‹â€èŠ‚ç‚¹ä¸ºæ­¢ã€‚
         * åªæœ‰å½“å›¾çš„ç»“æ„ç¨³å®šåï¼Œæ‰æ‰§è¡Œæœ€ç»ˆçš„åˆ é™¤æ“ä½œã€‚
         *
         * @param {NodeSingular} nodeToDelete - ç”¨æˆ·æœ€åˆé€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚
         */
        function deleteNodeAndPruneChain(nodeToDelete) {
            if (!nodeToDelete || nodeToDelete.removed()) return;

            // åˆå§‹åŒ–å¾…åˆ é™¤èŠ‚ç‚¹çš„é›†åˆï¼Œé¦–å…ˆåŒ…å«ç”¨æˆ·ç‚¹å‡»çš„èŠ‚ç‚¹
            const nodesToPrune = cy.collection(nodeToDelete);
            let nodesAddedInLastPass;

            // å¼€å§‹è¿­ä»£è¿‡ç¨‹ã€‚åªè¦ä¸Šä¸€è½®è¿­ä»£æœ‰æ”¶è·ï¼ˆå³æœ‰æ–°èŠ‚ç‚¹è¢«åŠ å…¥å¾…åˆ é™¤åˆ—è¡¨ï¼‰ï¼Œå°±ç»§ç»­å¾ªç¯ã€‚
            do {
                nodesAddedInLastPass = 0;

                // åœ¨æ¯ä¸€è½®è¿­ä»£ä¸­ï¼Œéå†å›¾ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹
                cy.nodes().forEach(currentNode => {
                    // å¦‚æœèŠ‚ç‚¹å·²åœ¨å¾…åˆ é™¤åˆ—è¡¨ï¼Œåˆ™è·³è¿‡ï¼Œé¿å…é‡å¤è®¡ç®—
                    if (nodesToPrune.has(currentNode)) {
                        return;
                    }

                    const parents = currentNode.incomers().nodes();
                    const children = currentNode.outgoers().nodes();

                    // åˆ¤æ–­æ¡ä»¶1ï¼šä¸Šæ¸¸å­¤ç«‹ã€‚
                    // å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å­˜åœ¨çˆ¶èŠ‚ç‚¹ï¼Œä¸”å®ƒæ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹éƒ½å·²ç»è¢«æ ‡è®°ä¸ºå¾…åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹ä¹Ÿåº”è¯¥è¢«åˆ é™¤ã€‚
                    if (parents.length > 0 && parents.every(p => nodesToPrune.has(p))) {
                        nodesToPrune.merge(currentNode);
                        nodesAddedInLastPass++;
                        return; // å·²å¤„ç†ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„éå†
                    }

                    // åˆ¤æ–­æ¡ä»¶2ï¼šä¸‹æ¸¸å­¤ç«‹ã€‚
                    // å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹ï¼Œä¸”å®ƒæ‰€æœ‰çš„å­èŠ‚ç‚¹éƒ½å·²ç»è¢«æ ‡è®°ä¸ºå¾…åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹æœ¬èº«ä¹Ÿå¤±å»äº†å­˜åœ¨çš„æ„ä¹‰ï¼Œä¹Ÿåº”è¯¥è¢«åˆ é™¤ã€‚
                    if (children.length > 0 && children.every(c => nodesToPrune.has(c))) {
                        nodesToPrune.merge(currentNode);
                        nodesAddedInLastPass++;
                    }
                });

            } while (nodesAddedInLastPass > 0); // å½“ä¸€è½®å¾ªç¯ä¸‹æ¥æ²¡æœ‰ä»»ä½•æ–°èŠ‚ç‚¹è¢«æ·»åŠ ï¼Œè¯´æ˜å·²æ”¶æ•›ï¼Œå¾ªç¯ç»“æŸã€‚

            // è¿­ä»£æ”¶æ•›åï¼Œä¸€æ¬¡æ€§ä»å›¾ä¸­ç§»é™¤æ‰€æœ‰è¢«æ ‡è®°çš„èŠ‚ç‚¹å’Œç›¸å…³çš„è¾¹
            if (nodesToPrune.length > 0) {
                cy.remove(nodesToPrune);
            }

            // æ¸…ç†UIçŠ¶æ€
            resetHighlight();
            targetNodeForMenu = null;
            lastSelectedNode = null;
        }

        // *** NEW: Search and Highlight Function ***
        /**
         * Finds all nodes matching the query and scope, then highlights their entire call chains.
         * @param {string} query - The search term.
         * @param {string} scope - 'all', 'class', or 'method'.
         */
        function executeSearchAndHighlight(query, scope) {
            const lowerCaseQuery = query.toLowerCase().trim();
            if (!lowerCaseQuery) {
                resetHighlight();
                return;
            }

            // 1. Find all nodes that match the search criteria.
            const matchingNodes = cy.nodes().filter(node => {
                const data = node.data();
                const className = data.className.toLowerCase();
                const methodName = data.methodName.toLowerCase();
                switch(scope) {
                    case 'class': return className.includes(lowerCaseQuery);
                    case 'method': return methodName.includes(lowerCaseQuery);
                    default: // 'all'
                        return className.includes(lowerCaseQuery) || methodName.includes(lowerCaseQuery);
                }
            });

            if (matchingNodes.length === 0) {
                resetHighlight();
                return;
            }

            // 2. For each matching node, get its full call chain (node + ancestors + successors).
            let elementsToHighlight = cy.collection();
            matchingNodes.forEach(node => {
                const chain = node.union(node.predecessors()).union(node.successors());
                elementsToHighlight = elementsToHighlight.union(chain);
            });

            // 3. Highlight the combined collection of all chains.
            highlightElements(elementsToHighlight);
        }

        // =========================================================================
        // === 3. äº‹ä»¶ç»‘å®š (Event Handling)
        // =========================================================================

        // --- å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨ä¸Šä¸‹æ–‡çŠ¶æ€ ---
        const contextMenu = document.getElementById('context-menu');
        const helpModal = document.getElementById('help-modal');
        const searchInput = document.getElementById('search-input');
        const searchScopeSelect = document.getElementById('search-scope-select');
        const suggestionsContainer = document.getElementById('autocomplete-suggestions');

        let targetNodeForMenu = null; // å­˜å‚¨å³é”®ç‚¹å‡»çš„èŠ‚ç‚¹
        let lastSelectedNode = null;  // å­˜å‚¨æœ€åå·¦é”®å•å‡»çš„èŠ‚ç‚¹

        // --- Cytoscape ç”»å¸ƒäº‹ä»¶ ---
        // å“åº”èŠ‚ç‚¹å³é”®ç‚¹å‡»ï¼Œåœ¨é¼ æ ‡ä½ç½®æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
        cy.on('cxttap', 'node', (evt) => {
            evt.preventDefault();
            targetNodeForMenu = evt.target;
            contextMenu.style.left = evt.originalEvent.pageX + 'px';
            contextMenu.style.top = evt.originalEvent.pageY + 'px';
            contextMenu.style.display = 'block';
        });

        // å“åº”èŠ‚ç‚¹å·¦é”®å•å‡»ï¼Œé«˜äº®å…¶å®Œæ•´çš„ä¸Šä¸‹æ¸¸è°ƒç”¨é“¾
        cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            lastSelectedNode = node;
            highlightElements(node.union(node.predecessors()).union(node.successors()));
        });

        // å“åº”ç”»å¸ƒç©ºç™½åŒºåŸŸçš„ç‚¹å‡»ï¼Œç”¨äºéšè—èœå•å’Œæ¸…é™¤é«˜äº®
        cy.on('tap', (evt) => {
            if (evt.target === cy) {
                contextMenu.style.display = 'none';
                resetHighlight();
                lastSelectedNode = null;
            }
        });

        // --- UIæ§ä»¶äº‹ä»¶ ---
        // ä¸Šä¸‹æ–‡èœå•ä¸­çš„â€œå¤åˆ¶â€å’Œâ€œåˆ é™¤â€æŒ‰é’®
        document.getElementById('copy-node-info-btn').addEventListener('click', () => {
            contextMenu.style.display = 'none';
            copyNodeInfo(targetNodeForMenu);
        });
        document.getElementById('delete-node-btn').addEventListener('click', () => {
            contextMenu.style.display = 'none';
            deleteNodeAndPruneChain(targetNodeForMenu);
        });

        // å¸®åŠ©å¼¹çª—çš„æ˜¾ç¤ºä¸éšè—é€»è¾‘
        document.getElementById('help-button').addEventListener('click', () => { helpModal.style.display = 'flex'; });
        helpModal.querySelector('.modal-close-btn').addEventListener('click', () => { helpModal.style.display = 'none'; });

        // é¡¶éƒ¨æ§åˆ¶æ çš„æŒ‰é’®å’Œä¸‹æ‹‰æ¡†
        document.getElementById('reset-button').addEventListener('click', () => {
            resetHighlight();
            searchInput.value = '';
            suggestionsContainer.style.display = 'none';
            cy.fit(null, 50);
        });
        document.getElementById('layout-select').addEventListener('change', function () { cy.layout({ name: this.value, rankDir: 'LR', animate: true, spacingFactor: 1.5 }).run(); });

        // *** NEW: Autocomplete and Search Logic ***
        function updateSuggestions() {
            const query = searchInput.value.toLowerCase().trim();
            const scope = searchScopeSelect.value;

            if (!query) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                return;
            }

            // 1. æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„èŠ‚ç‚¹
            const filteredNodes = searchableData.filter(item => {
                switch(scope) {
                    case 'class': return item.className.includes(query);
                    case 'method': return item.methodName.includes(query);
                    default: // 'all'
                        return item.className.includes(query) || item.methodName.includes(query);
                }
            });

            // 2. æ”¶é›†æ‰€æœ‰å¯èƒ½çš„å»ºè®®ï¼Œå¹¶ä½¿ç”¨ Map è¿›è¡Œå»é‡
            const suggestionsMap = new Map();
            filteredNodes.forEach(item => {
                // åœ¨'all'æˆ–'class'ä½œç”¨åŸŸä¸‹ï¼Œå¦‚æœç±»ååŒ¹é…ï¼Œæ·»åŠ ç±»åå»ºè®®
                if ((scope === 'all' || scope === 'class') && item.className.includes(query)) {
                    if (!suggestionsMap.has(item.fullClassName)) {
                        suggestionsMap.set(item.fullClassName, { text: item.fullClassName, type: 'class' });
                    }
                }
                // åœ¨'all'æˆ–'method'ä½œç”¨åŸŸä¸‹ï¼Œå¦‚æœæ–¹æ³•ååŒ¹é…ï¼Œæ·»åŠ æ–¹æ³•åå»ºè®®
                if ((scope === 'all' || scope === 'method') && item.methodName.includes(query)) {
                    if (!suggestionsMap.has(item.fullMethodName)) {
                        suggestionsMap.set(item.fullMethodName, { text: item.fullMethodName, type: 'method' });
                    }
                }
            });

            // 3. ä» Map ä¸­è·å–å»é‡åçš„å»ºè®®åˆ—è¡¨ï¼Œå¹¶é™åˆ¶æ•°é‡
            const finalSuggestions = Array.from(suggestionsMap.values()).slice(0, 50);

            if (finalSuggestions.length === 0) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                return;
            }

            // 4. ä½¿ç”¨å»é‡åçš„åˆ—è¡¨ç”Ÿæˆ HTML
            suggestionsContainer.innerHTML = finalSuggestions.map(item => {
                return `<div class="suggestion-item" data-text="${item.text}">
                            <span class="item-text">${item.text}</span>
                            <span class="item-type">${item.type}</span>
                        </div>`;
            }).join('');
            suggestionsContainer.style.display = 'block';
        }

        searchInput.addEventListener('input', updateSuggestions);
        searchInput.addEventListener('focus', updateSuggestions);

        searchScopeSelect.addEventListener('change', () => {
            // Re-evaluate suggestions when scope changes
            updateSuggestions();
            searchInput.focus();
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                executeSearchAndHighlight(searchInput.value, searchScopeSelect.value);
                suggestionsContainer.style.display = 'none';
                searchInput.blur();
            }
        });

        suggestionsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.suggestion-item');
            if (target) {
                const text = target.getAttribute('data-text');
                searchInput.value = text;
                executeSearchAndHighlight(text, searchScopeSelect.value);
                suggestionsContainer.style.display = 'none';
            }
        });

        // Hide popups when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-wrapper')) {
                suggestionsContainer.style.display = 'none';
            }
            if (!e.target.closest('.context-menu')) {
                contextMenu.style.display = 'none';
            }
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });



        // --- å…¨å±€é”®ç›˜å¿«æ·é”® ---
        document.addEventListener('keydown', (event) => {
            // Escé”®ï¼šå…³é—­å¸®åŠ©å¼¹çª—
            if (event.key === 'Escape' && helpModal.style.display === 'flex') {
                helpModal.style.display = 'none';
            }

            // Cmd/Ctrl + Cï¼šå¤åˆ¶é€‰ä¸­èŠ‚ç‚¹çš„ä¿¡æ¯
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                if (lastSelectedNode) { event.preventDefault(); copyNodeInfo(lastSelectedNode); }
            }

            // Delete / Cmd + Backspaceï¼šåˆ é™¤é€‰ä¸­èŠ‚ç‚¹å¹¶ä¿®å‰ªé“¾è·¯
            const isDeleteKey = event.key === 'Delete';
            const isMacDelete = event.metaKey && event.key === 'Backspace';
            // ç¡®ä¿ç„¦ç‚¹ä¸åœ¨è¾“å…¥æ¡†å†…ï¼Œä»¥é˜²è¯¯åˆ 
            if ((isDeleteKey || isMacDelete) && !['INPUT', 'SELECT'].includes(document.activeElement.tagName)) {
                if (lastSelectedNode) { event.preventDefault(); deleteNodeAndPruneChain(lastSelectedNode); }
            }
        });
    });
</script>
</body>
</html>
