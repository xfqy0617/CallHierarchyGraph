<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.min.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; display: flex; flex-direction: column;
        }
        #cy {
            flex-grow: 1; position: relative;
            background-color: #f8f9fa;
            transition: background-color 0.4s ease;
        }
        body.highlight-active #cy { background-color: #e9ecef; }

        .controls {
            display: flex; align-items: center; gap: 16px;
            padding: 10px 20px; background-color: #ffffff;
            border-bottom: 1px solid #e9ecef; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; font-weight: 500; color: #495057; }
        select, input[type="text"], button {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;
            font-size: 13px; background-color: #fff;
            transition: all 0.2s ease-in-out;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }
        button:hover { background-color: #0069d9; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }

        .node-card {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;
            padding: 10px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 300px; user-select: text; pointer-events: none;
            text-align: left; position: relative;
            transition: opacity 0.4s ease, filter 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .node-class-name { font-size: 18px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
        .node-method-name { font-size: 14px; font-weight: 600; color: #00529b; margin-bottom: 4px; }
        .node-params, .node-package-name { font-size: 7px; color: #6c757d; line-height: 0.9; }
        .node-package-name { margin-top: 3px; border-top: 1px dashed #eee; padding-top: 3px; }
        .node-card.dimmed { opacity: 0.15; filter: grayscale(80%); }
        .node-card.highlighted { opacity: 1 !important; filter: none !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4); }

        /* [Êñ∞ÂäüËÉΩ] Â§çÂà∂ÊàêÂäüÂêéÁöÑÂèçÈ¶àÊ†∑Âºè */
        .node-card.copied { border-color: #28a745; }
        .copy-feedback {
            display: none;
            position: absolute; top: 5px; right: 8px;
            background-color: #28a745; color: white;
            padding: 2px 6px; border-radius: 4px;
            font-size: 10px; font-weight: bold;
        }
        .node-card.copied .copy-feedback { display: block; }

        .context-menu {
            display: none; position: absolute; z-index: 1000;
            background-color: #ffffff; border: 1px solid #ccc;
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px 0; min-width: 220px;
        }
        .context-menu ul { list-style: none; padding: 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; font-size: 13px; cursor: pointer; display: flex; align-items: center; }
        .context-menu ul li:hover { background-color: #007bff; color: white; }
        .context-menu ul li .icon { margin-right: 10px; font-size: 16px; }

    </style>
</head>
<body>

<div class="controls">
    <div class="control-group">
        <label for="layout-select">Â∏ÉÂ±Ä:</label>
        <select id="layout-select">
            <option value="dagre" selected>Dagre (Tree)</option>
            <option value="breadthfirst">Breadthfirst</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option></select>
    </div>
    <div class="control-group">
        <label for="search-input">Êü•ËØ¢:</label>
        <input type="text" id="search-input" placeholder="Êü•ËØ¢Á±ªÊàñÊñπÊ≥ï...">
    </div>
    <button id="reset-button">ÈáçÁΩÆ</button>
</div>

<div id="cy"></div>

<!-- [Êñ∞ÂäüËÉΩ] Êõ¥Êñ∞Âè≥ÈîÆËèúÂçï HTML -->
<div id="context-menu" class="context-menu">
    <ul>
        <li id="copy-node-info-btn"><span class="icon">üìã</span>Â§çÂà∂</li>
        <li id="delete-node-btn"><span class="icon">üóëÔ∏è</span>Âà†Èô§ËäÇÁÇπ&‰øÆÂâ™ÈìæË∑Ø</li>
    </ul>
</div>

<script>
    if(typeof cytoscapeNodeHtmlLabel === 'function') cytoscape.use(cytoscapeNodeHtmlLabel);
    if(typeof cytoscapeDagre === 'function') cytoscape.use(cytoscapeDagre);

    document.addEventListener('DOMContentLoaded', function () {
        const graphData = '{graph_data_placeholder}';
        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "Error: Could not load graph data.";
            return;
        }

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: graphData.nodes.map(node => ({ data: { id: node.id, ...node } })),
                edges: graphData.edges.map(edge => ({ data: { id: `edge_${edge.source}_${edge.target}`, source: edge.source, target: edge.target } }))
            },
            style: [
                { selector: 'node', style: { 'background-opacity': 0, 'border-width': 0, 'width': 320, 'height': 110, 'shape': 'rectangle' }},
                { selector: 'edge', style: { 'width': 2, 'line-color': '#adb5bd', 'target-arrow-color': '#adb5bd', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'transition-property': 'line-color, target-arrow-color, width, opacity', 'transition-duration': '0.3s' }},
                { selector: 'edge.highlighted', style: { 'line-color': '#007bff', 'target-arrow-color': '#007bff', 'width': 3.5, 'opacity': 1, 'z-index': 100 }},
                { selector: 'edge.dimmed', style: { 'opacity': 0.1 }}
            ],
            layout: { name: 'dagre', rankDir: 'LR', spacingFactor: 1.5 }
        });

        cy.nodeHtmlLabel([
            {
                query: 'node', valign: "center", halign: "center",
                tpl: (data) => {
                    let borderStyle = '', bgColor = '';
                    switch(data.nodeType) {
                        case 'ROOT': borderStyle = 'border-left: 5px solid #b0bec5;'; bgColor = '#eceff1'; break;
                        case 'LEAF': borderStyle = 'border-left: 5px solid #66bb6a;'; bgColor = '#e8f5e9'; break;
                        default: borderStyle = 'border-left: 5px solid #42a5f5;'; bgColor = '#e3f2fd'; break;
                    }
                    const finalStyle = `${borderStyle} background-color: ${bgColor};`;
                    return `<div id="card-${data.id}" class="node-card" style="${finalStyle}">
                                <div class="copy-feedback">Copied!</div>
                                <div class="node-class-name" style="color: ${data.classColor};" title="${data.className}">${data.className}</div>
                                <div class="node-method-name" title="${data.methodName}">${data.methodName}</div>
                                <div class="node-params" title="${data.params}">(${data.params})</div>
                                <div class="node-package-name" title="${data.packageName}">${data.packageName}</div>
                            </div>`;
                }
            }
        ]);

        function highlightElements(elementsToShow) {
            document.body.classList.add('highlight-active');
            cy.edges().addClass('dimmed');
            $('.node-card').addClass('dimmed').removeClass('highlighted');
            elementsToShow.edges().removeClass('dimmed').addClass('highlighted');
            elementsToShow.nodes().forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
        }

        function resetHighlight() {
            document.body.classList.remove('highlight-active');
            cy.elements().removeClass('dimmed highlighted');
            $('.node-card').removeClass('dimmed highlighted');
        }

        // --- [Êñ∞ÂäüËÉΩ] Â§çÂà∂ÈÄªËæë ---
        function copyNodeInfo(node) {
            if (!node) return;
            const data = node.data();
            const textToCopy = `${data.packageName}.${data.className}#${data.methodName}`;

            navigator.clipboard.writeText(textToCopy).then(() => {
                console.log('Copied:', textToCopy);
                const card = $(`#card-${node.id()}`);
                card.addClass('copied');
                setTimeout(() => card.removeClass('copied'), 1500); // 1.5ÁßíÂêéÁßªÈô§ÂèçÈ¶à
            }).catch(err => {
                console.error('Failed to copy text:', err);
                alert('Failed to copy text. See console for details.');
            });
        }

        const contextMenu = document.getElementById('context-menu');
        const deleteButton = document.getElementById('delete-node-btn');
        const copyButton = document.getElementById('copy-node-info-btn'); // Êñ∞Â¢û
        let targetNodeForMenu = null;
        let lastSelectedNode = null; // [‰ºòÂåñ] Áî®‰∫éÈîÆÁõòÂø´Êç∑ÈîÆ

        cy.on('cxttap', 'node', (evt) => {
            evt.preventDefault();
            targetNodeForMenu = evt.target;
            contextMenu.style.left = evt.originalEvent.pageX + 'px';
            contextMenu.style.top = evt.originalEvent.pageY + 'px';
            contextMenu.style.display = 'block';
        });

        cy.on('tap', (evt) => {
            if (evt.target === cy) {
                contextMenu.style.display = 'none';
                resetHighlight();
                lastSelectedNode = null; // [‰ºòÂåñ] ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÔºåÊ∏ÖÈô§ÈÄâ‰∏≠ËäÇÁÇπ
            }
        });

        // [‰ºòÂåñ] Êõ¥Êñ∞ËäÇÁÇπÁÇπÂáª‰∫ã‰ª∂ÔºåËÆ∞ÂΩïÊúÄÂêéÈÄâ‰∏≠ÁöÑËäÇÁÇπ
        cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            lastSelectedNode = node; // ËÆ∞ÂΩï
            highlightElements(node.union(node.predecessors()).union(node.successors()));
        });

        // --- Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂ÁõëÂê¨ ---
        copyButton.addEventListener('click', () => {
            copyNodeInfo(targetNodeForMenu);
            contextMenu.style.display = 'none';
        });

        deleteButton.addEventListener('click', () => {
            if (!targetNodeForMenu) return;
            contextMenu.style.display = 'none';
            const nodesToPrune = cy.collection(targetNodeForMenu);
            let queue = [], processedIds = new Set();
            queue.push(...targetNodeForMenu.outgoers().nodes());
            processedIds.add(targetNodeForMenu.id());
            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());
                if (currentNode.incomers().nodes().every(p => nodesToPrune.has(p))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.outgoers().nodes());
                }
            }
            queue = [], processedIds.clear();
            queue.push(...targetNodeForMenu.incomers().nodes());
            processedIds.add(targetNodeForMenu.id());
            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());
                if (currentNode.outgoers().nodes().filter(c => c.id() !== currentNode.id()).every(c => nodesToPrune.has(c))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.incomers().nodes());
                }
            }
            if (nodesToPrune.length > 0) cy.remove(nodesToPrune);
            resetHighlight();
            targetNodeForMenu = null;
            lastSelectedNode = null;
        });

        // --- [Êñ∞ÂäüËÉΩ] ÈîÆÁõòÂø´Êç∑ÈîÆÁõëÂê¨ ---
        document.addEventListener('keydown', (event) => {
            // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ã‰∫Ü Cmd/Ctrl + C
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                if (lastSelectedNode) {
                    event.preventDefault(); // ÈòªÊ≠¢ÊµèËßàÂô®ÈªòËÆ§ÁöÑÂ§çÂà∂Ë°å‰∏∫
                    copyNodeInfo(lastSelectedNode);
                }
            }
        });

        // --- ÂÖ∂‰ªñUI‰∫ã‰ª∂ ---
        document.getElementById('reset-button').addEventListener('click', () => { resetHighlight(); document.getElementById('search-input').value = ''; cy.fit(null, 50); });
        document.getElementById('layout-select').addEventListener('change', function () { cy.layout({ name: this.value, rankDir: 'LR', animate: true, spacingFactor: 1.5 }).run(); });

        let timeout;
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                resetHighlight();
                if (!query) return;
                const searchResults = cy.nodes().filter(node => node.data('className').toLowerCase().includes(query) || node.data('methodName').toLowerCase().includes(query) || node.data('packageName').toLowerCase().includes(query));
                if (searchResults.length > 0) {
                    document.body.classList.add('highlight-active');
                    cy.edges().addClass('dimmed');
                    $('.node-card').addClass('dimmed').removeClass('highlighted');
                    searchResults.forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
                }
            }, 300);
        });
    });
</script>
</body>
</html>
