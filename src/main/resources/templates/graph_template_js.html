<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.min.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; display: flex; flex-direction: column;
        }
        #cy {
            flex-grow: 1; position: relative;
            background-color: #f8f9fa;
            transition: background-color 0.4s ease;
        }
        body.highlight-active #cy { background-color: #e9ecef; }

        .controls {
            display: flex; align-items: center; gap: 16px;
            padding: 10px 20px; background-color: #ffffff;
            border-bottom: 1px solid #e9ecef; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; font-weight: 500; color: #495057; }
        select, input[type="text"], button {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;
            font-size: 13px; background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }
        button:hover { background-color: #0069d9; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }

        .node-card {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;
            padding: 10px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 300px; user-select: text; pointer-events: none;
            text-align: left;
            transition: opacity 0.4s ease, filter 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        .node-class-name { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
        .node-method-name { font-size: 13px; font-weight: 600; color: #00529b; margin-bottom: 4px; }
        .node-params, .node-package-name { font-size: 11px; color: #6c757d; line-height: 1.3; }
        .node-package-name { margin-top: 6px; border-top: 1px dashed #eee; padding-top: 4px; }
        .node-card.dimmed { opacity: 0.15; filter: grayscale(80%); }
        .node-card.highlighted { opacity: 1 !important; filter: none !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4); }

        .context-menu {
            display: none; position: absolute; z-index: 1000;
            background-color: #ffffff; border: 1px solid #ccc;
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px 0; min-width: 220px;
        }
        .context-menu ul { list-style: none; padding: 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; font-size: 13px; cursor: pointer; display: flex; align-items: center; }
        .context-menu ul li:hover { background-color: #007bff; color: white; }
        .context-menu ul li .icon { margin-right: 10px; font-size: 16px; }

    </style>
</head>
<body>

<div class="controls">
    <div class="control-group">
        <label for="layout-select">Layout:</label>
        <select id="layout-select"><option value="dagre" selected>Dagre (Tree)</option><option value="breadthfirst">Breadthfirst</option><option value="circle">Circle</option><option value="grid">Grid</option></select>
    </div>
    <div class="control-group">
        <label for="search-input">Search:</label>
        <input type="text" id="search-input" placeholder="Search class or method...">
    </div>
    <button id="reset-button">Reset View & Highlight</button>
</div>

<div id="cy"></div>

<div id="context-menu" class="context-menu">
    <ul>
        <li id="delete-node-btn"><span class="icon">üóëÔ∏è</span>Delete Node & Prune Chain</li>
    </ul>
</div>

<script>
    if(typeof cytoscapeNodeHtmlLabel === 'function') cytoscape.use(cytoscapeNodeHtmlLabel);
    if(typeof cytoscapeDagre === 'function') cytoscape.use(cytoscapeDagre);

    document.addEventListener('DOMContentLoaded', function () {
        const graphData = '{graph_data_placeholder}';
        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "Error: Could not load graph data.";
            return;
        }

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: graphData.nodes.map(node => ({ data: { id: node.id, ...node } })),
                edges: graphData.edges.map(edge => ({ data: { id: `edge_${edge.source}_${edge.target}`, source: edge.source, target: edge.target } }))
            },
            style: [
                { selector: 'node', style: { 'background-opacity': 0, 'border-width': 0, 'width': 320, 'height': 110, 'shape': 'rectangle' }},
                { selector: 'edge', style: { 'width': 2, 'line-color': '#adb5bd', 'target-arrow-color': '#adb5bd', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'transition-property': 'line-color, target-arrow-color, width, opacity', 'transition-duration': '0.3s' }},
                { selector: 'edge.highlighted', style: { 'line-color': '#007bff', 'target-arrow-color': '#007bff', 'width': 3.5, 'opacity': 1, 'z-index': 100 }},
                { selector: 'edge.dimmed', style: { 'opacity': 0.1 }}
            ],
            layout: { name: 'dagre', rankDir: 'LR', spacingFactor: 1.5 }
        });

        cy.nodeHtmlLabel([
            {
                query: 'node', valign: "center", halign: "center",
                tpl: (data) => {
                    let borderStyle = '', bgColor = '';
                    switch(data.nodeType) {
                        case 'ROOT': borderStyle = 'border-left: 5px solid #b0bec5;'; bgColor = '#eceff1'; break;
                        case 'LEAF': borderStyle = 'border-left: 5px solid #66bb6a;'; bgColor = '#e8f5e9'; break;
                        default: borderStyle = 'border-left: 5px solid #42a5f5;'; bgColor = '#e3f2fd'; break;
                    }
                    const finalStyle = `${borderStyle} background-color: ${bgColor};`;
                    return `<div id="card-${data.id}" class="node-card" style="${finalStyle}"><div class="node-class-name" style="color: ${data.classColor};" title="${data.className}">${data.className}</div><div class="node-method-name" title="${data.methodName}">${data.methodName}</div><div class="node-params" title="${data.params}">(${data.params})</div><div class="node-package-name" title="${data.packageName}">${data.packageName}</div></div>`;
                }
            }
        ]);

        function highlightElements(elementsToShow) {
            document.body.classList.add('highlight-active');
            cy.edges().addClass('dimmed');
            $('.node-card').addClass('dimmed').removeClass('highlighted');
            elementsToShow.edges().removeClass('dimmed').addClass('highlighted');
            elementsToShow.nodes().forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
        }

        function resetHighlight() {
            document.body.classList.remove('highlight-active');
            cy.elements().removeClass('dimmed highlighted');
            $('.node-card').removeClass('dimmed highlighted');
        }

        const contextMenu = document.getElementById('context-menu');
        const deleteButton = document.getElementById('delete-node-btn');
        let targetNodeForMenu = null;

        cy.on('cxttap', 'node', (evt) => {
            evt.preventDefault();
            targetNodeForMenu = evt.target;
            contextMenu.style.left = evt.originalEvent.pageX + 'px';
            contextMenu.style.top = evt.originalEvent.pageY + 'px';
            contextMenu.style.display = 'block';
        });

        cy.on('tap', () => { if (contextMenu.style.display === 'block') contextMenu.style.display = 'none'; });

        deleteButton.addEventListener('click', () => {
            if (!targetNodeForMenu) return;

            contextMenu.style.display = 'none';

            // --- Êñ∞ÁöÑ„ÄÅÁ≤æÁ°ÆÁöÑÂà†Èô§ÈÄªËæëÂÆûÁé∞ ---

            // 1. ÂàùÂßãÂåñ
            const nodesToPrune = cy.collection(targetNodeForMenu);
            let queue = [];
            let processedIds = new Set();

            // 2. Âêë‰∏ãÊ∏∏‰øÆÂâ™ (BFS)
            queue.push(...targetNodeForMenu.outgoers().nodes());
            processedIds.add(targetNodeForMenu.id());

            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());

                const parents = currentNode.incomers().nodes();

                // ÂÖ≥ÈîÆÂà§Êñ≠: ÂΩìÂâçËäÇÁÇπÁöÑÊâÄÊúâÁà∂ËäÇÁÇπÊòØÂê¶ÈÉΩÂ∑≤Âú®ÂæÖÂà†Èô§ÈõÜÂêà‰∏≠
                if (parents.every(p => nodesToPrune.has(p))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.outgoers().nodes());
                }
            }

            // 3. Âêë‰∏äÊ∏∏‰øÆÂâ™ (BFS)
            queue = []; // ÈáçÁΩÆÈòüÂàó
            processedIds.clear(); // ÈáçÁΩÆÂ∑≤Â§ÑÁêÜÈõÜÂêà
            queue.push(...targetNodeForMenu.incomers().nodes());
            processedIds.add(targetNodeForMenu.id());

            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());

                const children = currentNode.outgoers().nodes();

                // ÂÖ≥ÈîÆÂà§Êñ≠: ÂΩìÂâçËäÇÁÇπÁöÑÊâÄÊúâÂ≠êËäÇÁÇπÊòØÂê¶ÈÉΩÂ∑≤Âú®ÂæÖÂà†Èô§ÈõÜÂêà‰∏≠
                // ÈúÄÂ§ÑÁêÜËá™Ë∞ÉÁî®ÊÉÖÂÜµ: Â¶ÇÊûú‰∏Ä‰∏™ËäÇÁÇπÂè™Ë∞ÉÁî®Ëá™Â∑±Ôºå‰∏îËá™Â∑±Â∞ÜË¢´Âà†Èô§ÔºåÈÇ£ÂÆÉ‰πüÂ∫îË¢´Âà†Èô§„ÄÇ
                const childrenToCheck = children.filter(c => c.id() !== currentNode.id());
                if (childrenToCheck.every(c => nodesToPrune.has(c))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.incomers().nodes());
                }
            }

            // 4. ÊâßË°åÂà†Èô§
            if (nodesToPrune.length > 0) {
                console.log('Pruning nodes:', nodesToPrune.map(n => n.data('methodName')));
                cy.remove(nodesToPrune);
            }

            targetNodeForMenu = null;
        });

        cy.on('tap', 'node', (evt) => highlightElements(evt.target.union(evt.target.predecessors()).union(evt.target.successors())));
        document.getElementById('reset-button').addEventListener('click', () => { resetHighlight(); document.getElementById('search-input').value = ''; cy.fit(null, 50); });
        document.getElementById('layout-select').addEventListener('change', function () { cy.layout({ name: this.value, rankDir: 'LR', animate: true, spacingFactor: 1.5 }).run(); });

        let timeout;
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                resetHighlight();
                if (!query) return;
                const searchResults = cy.nodes().filter(node => node.data('className').toLowerCase().includes(query) || node.data('methodName').toLowerCase().includes(query) || node.data('packageName').toLowerCase().includes(query));
                if (searchResults.length > 0) {
                    document.body.classList.add('highlight-active');
                    cy.edges().addClass('dimmed');
                    $('.node-card').addClass('dimmed').removeClass('highlighted');
                    searchResults.forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
                }
            }, 300);
        });
    });
</script>
</body>
</html>
