<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <style>
        /* --- Basic Layout & Theming --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f7f7;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Graph Container --- */
        #cy {
            flex-grow: 1; /* Takes up all available space */
            position: relative;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
        }

        /* --- Control Panel --- */
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        /* --- UI Elements --- */
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        select, input[type="text"], button {
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 13px;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        button {
            cursor: pointer;
            background-color: #007aff;
            color: white;
            border-color: #007aff;
            font-weight: 500;
        }

        button:hover {
            background-color: #005ecb;
        }

        #reset-button {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        #reset-button:hover {
            background-color: #5a6268;
        }
    </style>
    <!-- 1. 引入 Cytoscape.js 核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <!-- 2. 引入 Dagre 布局算法，非常适合有向图 -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
</head>
<body>

<div class="controls">
    <div class="control-group">
        <label for="layout-select">Layout:</label>
        <select id="layout-select">
            <option value="dagre" selected>Dagre (Tree)</option>
            <option value="breadthfirst">Breadthfirst</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
        </select>
    </div>
    <div class="control-group">
        <label for="search-input">Search:</label>
        <input type="text" id="search-input" placeholder="Search class or method...">
    </div>
    <button id="reset-button">Reset View & Highlight</button>
</div>

<div id="cy"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 这是我们的数据“契约”，由 Kotlin 后端注入
        const graphData = '{graph_data_placeholder}';

        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "Error: Could not load graph data.";
            return;
        }

        // --- 1. 初始化 Cytoscape ---
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: graphData.nodes.map(node => ({
                    data: {
                        id: node.id,
                        label: `${node.methodName}(${node.params})`, // 主标签显示方法名和参数
                        fullLabel: `${node.className}\n${node.methodName}(${node.params})\n${node.packageName}`, // 用于搜索和提示
                        ...node // 将所有原始数据附加到 data 对象
                    }
                })),
                edges: graphData.edges.map(edge => ({
                    data: {
                        id: `edge_${edge.source}_${edge.target}`,
                        source: edge.source,
                        target: edge.target
                    }
                }))
            },

            // --- 2. 定义样式 ---
            style: [
                {
                    selector: 'node',
                    style: {
                        'shape': 'round-rectangle',
                        'width': 'label', // 节点宽度适应标签
                        'height': 'label',
                        'padding': '10px',
                        'background-color': 'data(classColor)', // 使用后端生成的类颜色
                        'color': '#ffffff', // 白色文字
                        'label': 'data(label)',
                        'font-size': '12px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'text-wrap': 'wrap',
                        'text-max-width': '180px', // 防止标签过长
                        'text-outline-width': 2,
                        'text-outline-color': 'data(classColor)', // 文字描边，增强可读性
                        'border-width': 2,
                        'border-color': '#555'
                    }
                },
                { // 为根节点（分析入口）添加特殊样式
                    selector: 'node[?isRoot]',
                    style: {
                        'border-color': '#FFD700', // 金色边框
                        'border-width': 4,
                        'shape': 'diamond'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#b3b3b3',
                        'target-arrow-color': '#b3b3b3',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                },
                // --- 交互样式 ---
                {
                    selector: '.highlighted',
                    style: {
                        'background-color': '#007aff',
                        'line-color': '#007aff',
                        'target-arrow-color': '#007aff',
                        'transition-property': 'background-color, line-color, target-arrow-color',
                        'transition-duration': '0.2s'
                    }
                },
                {
                    selector: '.dimmed',
                    style: { 'opacity': 0.2 }
                }
            ],

            // --- 3. 初始布局 ---
            layout: {
                name: 'dagre',
                rankDir: 'LR', // Left-to-Right
                spacingFactor: 1.2
            }
        });

        // --- 4. 绑定交互事件 ---

        // 点击节点高亮其调用链
        cy.on('tap', 'node', function (evt) {
            const node = evt.target;
            cy.elements().removeClass('highlighted').removeClass('dimmed');

            // 高亮当前节点、所有上游（调用者）和下游（被调用者）
            const highlightCollection = node.union(node.successors()).union(node.predecessors());

            cy.elements().difference(highlightCollection).addClass('dimmed');
            highlightCollection.addClass('highlighted');
        });

        // 点击画布空白处，清除所有高亮
        cy.on('tap', function (evt) {
            if (evt.target === cy) {
                cy.elements().removeClass('highlighted').removeClass('dimmed');
            }
        });

        // 布局切换
        document.getElementById('layout-select').addEventListener('change', function () {
            const layoutName = this.value;
            cy.layout({
                name: layoutName,
                rankDir: 'LR',
                animate: true,
                spacingFactor: 1.2
            }).run();
        });

        // 搜索功能
        let timeout;
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                cy.elements().removeClass('highlighted').removeClass('dimmed');
                if (!query) return;

                const searchResults = cy.nodes().filter(node =>
                    node.data('fullLabel').toLowerCase().includes(query)
                );

                if (searchResults.length > 0) {
                    cy.elements().difference(searchResults).addClass('dimmed');
                    searchResults.addClass('highlighted');
                }
            }, 300); // Debounce search
        });

        // 重置按钮
        document.getElementById('reset-button').addEventListener('click', function() {
            cy.elements().removeClass('highlighted').removeClass('dimmed');
            document.getElementById('search-input').value = '';
            cy.fit(); // 视图恢复到初始大小和位置
            cy.center();
        });

    });
</script>
</body>
</html>