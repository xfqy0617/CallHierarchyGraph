<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.min.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; display: flex; flex-direction: column;
        }
        #cy {
            flex-grow: 1; position: relative;
            background-color: #f8f9fa;
            transition: background-color 0.4s ease;
        }
        body.highlight-active #cy { background-color: #e9ecef; }

        .controls {
            display: flex; align-items: center; gap: 16px;
            padding: 10px 20px; background-color: #ffffff;
            border-bottom: 1px solid #e9ecef; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; font-weight: 500; color: #495057; }
        select, input[type="text"], button {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;
            font-size: 13px; background-color: #fff;
            transition: all 0.2s ease-in-out;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }
        button:hover { background-color: #0069d9; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }
        #help-button { background-color: #fff400; color: #212529; border-color: #e0a800; } /* [新功能] 帮助按钮样式 */
        #help-button:hover { background-color: #fff400; }

        .node-card {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;
            padding: 10px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 300px; user-select: text; pointer-events: none;
            text-align: left; position: relative;
            transition: opacity 0.4s ease, filter 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .node-class-name { font-size: 18px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
        .node-method-name { font-size: 14px; font-weight: 600; color: #00529b; margin-bottom: 4px; }
        .node-params, .node-package-name { font-size: 7px; color: #6c757d; line-height: 0.9; }
        .node-package-name { margin-top: 3px; border-top: 1px dashed #eee; padding-top: 3px; }
        .node-card.dimmed { opacity: 0.15; filter: grayscale(80%); }
        .node-card.highlighted { opacity: 1 !important; filter: none !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4); }

        .node-card.copied { border-color: #28a745; }
        .copy-feedback { display: none; position: absolute; top: 5px; right: 8px; background-color: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .node-card.copied .copy-feedback { display: block; }

        .context-menu {
            display: none; position: absolute; z-index: 1000;
            background-color: #ffffff; border: 1px solid #ccc;
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px 0; min-width: 220px;
        }
        .context-menu ul { list-style: none; padding: 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; font-size: 13px; cursor: pointer; display: flex; align-items: center; }
        .context-menu ul li:hover { background-color: #007bff; color: white; }
        .context-menu ul li .icon { margin-right: 10px; font-size: 16px; }

        /* [新功能] 帮助弹框样式 */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: #fff; padding: 25px 35px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; max-width: 650px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 28px; font-weight: bold; color: #aaa;
            cursor: pointer; transition: color 0.2s;
        }
        .modal-close-btn:hover { color: #333; }
        .modal-content h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-content ul { padding-left: 20px; line-height: 1.8; }
        .modal-content kbd {
            background-color: #f7f7f7; border: 1px solid #ccc; border-radius: 4px;
            padding: 2px 6px; margin: 0 2px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em; color: #333;
        }

    </style>
</head>
<body>

<div class="controls">
    <button id="help-button">💡 使用须知</button>
    <div class="control-group">
        <label for="layout-select">布局:</label>
        <select id="layout-select"><option value="dagre" selected>Dagre (Tree)</option><option value="breadthfirst">Breadthfirst</option><option value="circle">Circle</option><option value="grid">Grid</option></select>
    </div>
    <div class="control-group">
        <label for="search-input">查询:</label>
        <input type="text" id="search-input" placeholder="查询类或方法...">
    </div>
    <button id="reset-button">重置</button>
</div>

<div id="cy"></div>

<div id="context-menu" class="context-menu">
    <ul>
        <li id="copy-node-info-btn"><span class="icon">📋</span>复制</li>
        <li id="delete-node-btn"><span class="icon">🗑️</span>删除节点&修剪链路</li>
    </ul>
</div>

<!-- [新功能] 帮助弹框 HTML 结构 -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn">×</span>
        <h2>使用须知</h2>
        <ul>
            <li><strong>查看与导航:</strong>
                <ul>
                    <li>使用鼠标滚轮进行缩放。</li>
                    <li>按住并拖动画布空白处进行平移。</li>
                </ul>
            </li>
            <li><strong>高亮调用链:</strong>
                <ul>
                    <li><strong>左键单击</strong>任意节点，即可高亮其完整的上游和下游调用链。</li>
                </ul>
            </li>
            <li><strong>复制节点信息:</strong>
                <ul>
                    <li><strong>左键单击</strong>选中节点后，按 <kbd>Cmd</kbd> + <kbd>C</kbd> (或 <kbd>Ctrl</kbd> + <kbd>C</kbd>)。</li>
                    <li>或<strong>右键单击</strong>节点，在菜单中选择“复制”。</li>
                </ul>
            </li>
            <li><strong>删除节点与修剪:</strong>
                <ul>
                    <li><strong>左键单击</strong>选中节点后，按 <kbd>Delete</kbd> 键 (或 <kbd>Cmd</kbd> + <kbd>Backspace</kbd>)。</li>
                    <li>或<strong>右键单击</strong>节点，在菜单中选择“删除节点&修剪链路”。</li>
                    <li>该操作会自动移除所有仅与被删除链路相关的“孤立”节点。</li>
                </ul>
            </li>
            <li><strong>重置视图:</strong>
                <ul>
                    <li>点击画布任意空白处，可清除所有高亮状态。</li>
                    <li>点击顶部的“重置”按钮，可清除高亮、清空搜索并使视图居中。</li>
                </ul>
            </li>
            <li><strong>关闭弹框:</strong>
                <ul>
                    <li>点击此弹框右上角的 <span style="font-size:1.2em; vertical-align:middle;">×</span> 按钮。</li>
                    <li>点击弹框外的灰色区域。</li>
                    <li>按 <kbd>ESC</kbd> 键。</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<script>
    if(typeof cytoscapeNodeHtmlLabel === 'function') cytoscape.use(cytoscapeNodeHtmlLabel);
    if(typeof cytoscapeDagre === 'function') cytoscape.use(cytoscapeDagre);

    document.addEventListener('DOMContentLoaded', function () {
        const graphData = '{graph_data_placeholder}';
        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "Error: Could not load graph data.";
            return;
        }

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: graphData.nodes.map(node => ({ data: { id: node.id, ...node } })),
                edges: graphData.edges.map(edge => ({ data: { id: `edge_${edge.source}_${edge.target}`, source: edge.source, target: edge.target } }))
            },
            style: [
                { selector: 'node', style: { 'background-opacity': 0, 'border-width': 0, 'width': 320, 'height': 110, 'shape': 'rectangle' }},
                { selector: 'edge', style: { 'width': 2, 'line-color': '#adb5bd', 'target-arrow-color': '#adb5bd', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'transition-property': 'line-color, target-arrow-color, width, opacity', 'transition-duration': '0.3s' }},
                { selector: 'edge.highlighted', style: { 'line-color': '#007bff', 'target-arrow-color': '#007bff', 'width': 3.5, 'opacity': 1, 'z-index': 100 }},
                { selector: 'edge.dimmed', style: { 'opacity': 0.1 }}
            ],
            layout: { name: 'dagre', rankDir: 'LR', spacingFactor: 1.5 }
        });

        cy.nodeHtmlLabel([
            {
                query: 'node', valign: "center", halign: "center",
                tpl: (data) => {
                    let borderStyle = '', bgColor = '';
                    switch(data.nodeType) {
                        case 'ROOT': borderStyle = 'border-left: 5px solid #b0bec5;'; bgColor = '#eceff1'; break;
                        case 'LEAF': borderStyle = 'border-left: 5px solid #66bb6a;'; bgColor = '#e8f5e9'; break;
                        default: borderStyle = 'border-left: 5px solid #42a5f5;'; bgColor = '#e3f2fd'; break;
                    }
                    const finalStyle = `${borderStyle} background-color: ${bgColor};`;
                    return `<div id="card-${data.id}" class="node-card" style="${finalStyle}"><div class="copy-feedback">Copied!</div><div class="node-class-name" style="color: ${data.classColor};" title="${data.className}">${data.className}</div><div class="node-method-name" title="${data.methodName}">${data.methodName}</div><div class="node-params" title="${data.params}">(${data.params})</div><div class="node-package-name" title="${data.packageName}">${data.packageName}</div></div>`;
                }
            }
        ]);

        function highlightElements(elementsToShow) {
            document.body.classList.add('highlight-active');
            cy.edges().addClass('dimmed');
            $('.node-card').addClass('dimmed').removeClass('highlighted');
            elementsToShow.edges().removeClass('dimmed').addClass('highlighted');
            elementsToShow.nodes().forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
        }

        function resetHighlight() {
            document.body.classList.remove('highlight-active');
            cy.elements().removeClass('dimmed highlighted');
            $('.node-card').removeClass('dimmed highlighted');
        }

        function copyNodeInfo(node) {
            if (!node) return;
            const data = node.data();
            const textToCopy = `${data.packageName}.${data.className}#${data.methodName}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const card = $(`#card-${node.id()}`);
                card.addClass('copied');
                setTimeout(() => card.removeClass('copied'), 1500);
            }).catch(err => console.error('Failed to copy text:', err));
        }

        function deleteNodeAndPruneChain(nodeToDelete) {
            if (!nodeToDelete) return;
            const nodesToPrune = cy.collection(nodeToDelete);
            let queue = [], processedIds = new Set();
            queue.push(...nodeToDelete.outgoers().nodes());
            processedIds.add(nodeToDelete.id());
            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());
                if (currentNode.incomers().nodes().every(p => nodesToPrune.has(p))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.outgoers().nodes());
                }
            }
            queue = [], processedIds.clear();
            queue.push(...nodeToDelete.incomers().nodes());
            processedIds.add(nodeToDelete.id());
            while (queue.length > 0) {
                const currentNode = queue.shift();
                if (processedIds.has(currentNode.id())) continue;
                processedIds.add(currentNode.id());
                if (currentNode.outgoers().nodes().filter(c => c.id() !== currentNode.id()).every(c => nodesToPrune.has(c))) {
                    nodesToPrune.merge(currentNode);
                    queue.push(...currentNode.incomers().nodes());
                }
            }
            if (nodesToPrune.length > 0) cy.remove(nodesToPrune);
            resetHighlight();
            targetNodeForMenu = null;
            lastSelectedNode = null;
        }

        const contextMenu = document.getElementById('context-menu');
        const deleteButton = document.getElementById('delete-node-btn');
        const copyButton = document.getElementById('copy-node-info-btn');
        let targetNodeForMenu = null;
        let lastSelectedNode = null;

        cy.on('cxttap', 'node', (evt) => {
            evt.preventDefault();
            targetNodeForMenu = evt.target;
            contextMenu.style.left = evt.originalEvent.pageX + 'px';
            contextMenu.style.top = evt.originalEvent.pageY + 'px';
            contextMenu.style.display = 'block';
        });

        cy.on('tap', (evt) => {
            if (evt.target === cy) {
                contextMenu.style.display = 'none';
                resetHighlight();
                lastSelectedNode = null;
            }
        });

        cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            lastSelectedNode = node;
            highlightElements(node.union(node.predecessors()).union(node.successors()));
        });

        copyButton.addEventListener('click', () => {
            contextMenu.style.display = 'none';
            copyNodeInfo(targetNodeForMenu);
        });

        deleteButton.addEventListener('click', () => {
            contextMenu.style.display = 'none';
            deleteNodeAndPruneChain(targetNodeForMenu);
        });

        // --- [新功能] 帮助弹框逻辑 ---
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const modalCloseBtn = helpModal.querySelector('.modal-close-btn');

        function openModal() { helpModal.style.display = 'flex'; }
        function closeModal() { helpModal.style.display = 'none'; }

        helpButton.addEventListener('click', openModal);
        modalCloseBtn.addEventListener('click', closeModal);
        helpModal.addEventListener('click', (event) => {
            if (event.target === helpModal) { // 点击灰色遮罩层时关闭
                closeModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal();
            }
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                if (lastSelectedNode) { event.preventDefault(); copyNodeInfo(lastSelectedNode); }
            }
            const isDeleteKey = event.key === 'Delete';
            const isMacDelete = event.metaKey && event.key === 'Backspace';
            if (isDeleteKey || isMacDelete) {
                if (lastSelectedNode) { event.preventDefault(); deleteNodeAndPruneChain(lastSelectedNode); }
            }
        });

        document.getElementById('reset-button').addEventListener('click', () => { resetHighlight(); document.getElementById('search-input').value = ''; cy.fit(null, 50); });
        document.getElementById('layout-select').addEventListener('change', function () { cy.layout({ name: this.value, rankDir: 'LR', animate: true, spacingFactor: 1.5 }).run(); });

        let timeout;
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                resetHighlight();
                if (!query) return;
                const searchResults = cy.nodes().filter(node => node.data('className').toLowerCase().includes(query) || node.data('methodName').toLowerCase().includes(query) || node.data('packageName').toLowerCase().includes(query));
                if (searchResults.length > 0) {
                    document.body.classList.add('highlight-active');
                    cy.edges().addClass('dimmed');
                    $('.node-card').addClass('dimmed').removeClass('highlighted');
                    searchResults.forEach(node => $(`#card-${node.id()}`).removeClass('dimmed').addClass('highlighted'));
                }
            }, 300);
        });
    });
</script>
</body>
</html>
