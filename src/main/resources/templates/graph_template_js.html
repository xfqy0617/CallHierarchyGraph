<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Hierarchy Graph</title>
    <style>
        /* --- Basic Layout & Theming --- */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; display: flex; flex-direction: column;
        }
        #cy {
            flex-grow: 1; position: relative;
            background-color: #f8f9fa;
        }

        /* --- Control Panel --- */
        .controls {
            display: flex; align-items: center; gap: 16px;
            padding: 10px 20px; background-color: #ffffff;
            border-bottom: 1px solid #e9ecef; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; font-weight: 500; color: #495057; }
        select, input[type="text"], button {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #ced4da;
            font-size: 13px; background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        button { cursor: pointer; background-color: #007bff; color: white; border-color: #007bff; font-weight: 500; }
        button:hover { background-color: #0069d9; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }

        /* --- [核心优化] Node Card Styling --- */
        .node-card {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            /* 背景色将由JS动态设置 */
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            width: 300px; /* 固定宽度以保持统一 */
            transition: all 0.2s ease-in-out;
            user-select: text;
            pointer-events: none; /* 让点击事件穿透到下层节点 */
            text-align: left;
        }
        .node-card:hover { /* 保留微妙的悬浮效果 */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }
        .node-class-name {
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }
        .node-method-name {
            font-size: 13px;
            font-weight: 600;
            color: #00529b;
            margin-bottom: 4px;
        }
        .node-params, .node-package-name {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.3;
        }
        .node-package-name {
            margin-top: 6px;
            border-top: 1px dashed #eee;
            padding-top: 4px;
        }
    </style>
    <!-- 依赖库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.min.js"></script>
</head>
<body>

<div class="controls">
    <div class="control-group">
        <label for="layout-select">Layout:</label>
        <select id="layout-select">
            <option value="dagre" selected>Dagre (Tree)</option>
            <option value="breadthfirst">Breadthfirst</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
        </select>
    </div>
    <div class="control-group">
        <label for="search-input">Search:</label>
        <input type="text" id="search-input" placeholder="Search class or method...">
    </div>
    <button id="reset-button">Reset View & Highlight</button>
</div>

<div id="cy"></div>

<script>
    if(typeof cytoscapeNodeHtmlLabel === 'function'){
        cytoscape.use(cytoscapeNodeHtmlLabel);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const graphData = '{graph_data_placeholder}';

        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error("Graph data is missing or invalid.");
            document.getElementById('cy').innerText = "Error: Could not load graph data.";
            return;
        }

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: graphData.nodes.map(node => ({ data: { id: node.id, ...node } })),
                edges: graphData.edges.map(edge => ({ data: { id: `edge_${edge.source}_${edge.target}`, source: edge.source, target: edge.target } }))
            },
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-opacity': 0,
                        'border-width': 0,
                        'width': 320,
                        'height': 110,
                        'shape': 'rectangle'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2.5,
                        'line-color': '#adb5bd',
                        'target-arrow-color': '#adb5bd',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                },
                {
                    selector: 'edge.highlighted',
                    style: {
                        'line-color': '#007bff',
                        'target-arrow-color': '#007bff',
                        'width': 4,
                        'z-index': 100
                    }
                },
                {
                    selector: 'edge.dimmed',
                    style: { 'opacity': 0.2 }
                }
            ],
            layout: { name: 'dagre', rankDir: 'LR', spacingFactor: 1.5 }
        });

        // [核心修改] 初始化HTML标签，使用新的模板和样式逻辑
        cy.nodeHtmlLabel([
            {
                query: 'node',
                valign: "center",
                halign: "center",
                tpl: function(data) {
                    let borderStyle = '';
                    let bgColor = '';

                    // 根据节点类型设置左侧边框颜色和背景色
                    switch(data.nodeType) {
                        case 'ROOT':
                            borderStyle = 'border-left: 5px solid #b0bec5;'; // Slate Gray
                            bgColor = '#eceff1'; // Lighter Slate
                            break;
                        case 'LEAF':
                            borderStyle = 'border-left: 5px solid #66bb6a;'; // Soft Green
                            bgColor = '#e8f5e9'; // Lighter Green
                            break;
                        case 'INTERMEDIATE':
                        default:
                            borderStyle = 'border-left: 5px solid #42a5f5;'; // Soft Blue
                            bgColor = '#e3f2fd'; // Lighter Blue
                            break;
                    }

                    // 最终的样式组合
                    const finalStyle = `${borderStyle} background-color: ${bgColor};`;

                    // 返回最终的卡片HTML结构（已移除徽章）
                    return `
                        <div id="card-${data.id}" class="node-card" style="${finalStyle}">
                            <div class="node-class-name" style="font-size=20px; color: ${data.classColor};" title="${data.className}">${data.className}</div>
                            <div class="node-method-name" style="font-size=16px;" title="${data.methodName}">${data.methodName}</div>
                            <div class="node-params" style="font-size=5px;" title="${data.params}">(${data.params})</div>
                            <div class="node-package-name" style="font-size=5px;" title="${data.packageName}">${data.packageName}</div>
                        </div>
                    `;
                }
            }
        ]);

        // --- 交互逻辑 (需要jQuery) ---
        function highlightPath(node) {
            const path = node.union(node.successors()).union(node.predecessors());
            const edges = path.edgesWith(path);

            cy.elements().addClass('dimmed');
            $('.node-card').css('opacity', 0.3);

            path.removeClass('dimmed');
            edges.removeClass('dimmed').addClass('highlighted');

            path.forEach(n => {
                if (n.isNode()) {
                    $(`#card-${n.id()}`).css('opacity', 1.0);
                }
            });
        }

        function resetHighlight() {
            cy.elements().removeClass('highlighted').removeClass('dimmed');
            $('.node-card').css('opacity', 1.0);
        }

        cy.on('tap', 'node', (evt) => highlightPath(evt.target));
        cy.on('tap', (evt) => { if (evt.target === cy) resetHighlight(); });

        document.getElementById('layout-select').addEventListener('change', function () { cy.layout({ name: this.value, rankDir: 'LR', animate: true, spacingFactor: 1.5 }).run(); });
        document.getElementById('reset-button').addEventListener('click', () => { resetHighlight(); document.getElementById('search-input').value = ''; cy.fit(null, 50); });

        let timeout;
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                resetHighlight();
                if (!query) return;
                const searchResults = cy.nodes().filter(node =>
                    node.data('className').toLowerCase().includes(query) ||
                    node.data('methodName').toLowerCase().includes(query) ||
                    node.data('packageName').toLowerCase().includes(query)
                );

                if (searchResults.length > 0) {
                    cy.elements().addClass('dimmed');
                    $('.node-card').css('opacity', 0.3);
                    searchResults.removeClass('dimmed');
                    searchResults.forEach(n => {
                        $(`#card-${n.id()}`).css('opacity', 1.0);
                    });
                }
            }, 300);
        });

        const script = document.createElement('script');
        script.src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js";
        document.head.appendChild(script);
    });
</script>
</body>
</html>
